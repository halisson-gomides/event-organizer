{% block content %}

<div class="modal">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h3 style="margin: 0;">{% if participant %}✏️ Editar{% else %}👤 Novo{% endif %} Participante</h3>
    <button hx-get="/participants" hx-target="#content" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">
      ✕
    </button>
  </div>

  <form {% if participant %}hx-patch{% else %}hx-post{% endif %}="/participants{% if participant %}/{{ participant.id }}{% endif %}"
        hx-target="#content"
        hx-swap="innerHTML"
        hx-indicator="#loading">
    
    <label>
      Nome Completo
      <input
        type="text"
        name="full_name"
        value="{{ participant.full_name if participant else '' }}"
        required
        maxlength="200">
    </label>

    <label>
      Data de Nascimento
      <input
        type="date"
        name="birth_date"
        value="{{ participant.birth_date.isoformat() if participant and participant.birth_date else '' }}"
        required>
    </label>

    <label>
      Telefone
      <input
        type="tel"
        name="phone"
        value="{{ participant.phone if participant else '' }}"
        maxlength="15"
        placeholder="(11) 99999-9999"
        oninput="formatPhoneNumber(this)">
    </label>

    <label>
      Responsável (para menores)
      <select name="guardian_id">
        <option value="">Nenhum</option>
        {% for guardian in guardians %}
          <option value="{{ guardian.id }}"
                  {% if participant and participant.guardian_id == guardian.id %}selected{% endif %}>
            {{ guardian.full_name }} ({{ guardian.birth_date }})
          </option>
        {% endfor %}
      </select>
    </label>

    <label>
      Observações
      <textarea
        name="observations"
        maxlength="200"
        rows="3">{{ participant.observations if participant else '' }}</textarea>
    </label>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
      <button type="button" hx-get="/participants" hx-swap="innerHTML">
        Cancelar
      </button>
      <button type="submit" id="loading" style="position: relative;">
        <span class="htmx-indicator" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
          ⏳
        </span>
        <span>💾 Salvar Participante</span>
      </button>
    </div>
  </form>
</div>

<script>
// Auto-close modal on successful submission
document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (evt.detail.target.id === 'content') {
    document.getElementById('modal').innerHTML = '';
  }
});

function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, ''); // Remove non-digits
    let formattedValue = '';

    if (value.length > 0) {
        formattedValue += '(' + value.substring(0, 2);
    }
    if (value.length > 2) {
        formattedValue += ') ' + value.substring(2, 7);
    }
    if (value.length > 7) {
        formattedValue += '-' + value.substring(7, 11);
    }

    input.value = formattedValue;
}
</script>

{% endblock %}