{% extends "base.html" %}
{% block title %}Eventos{% endblock %}
{% block content %}

<div class="action-bar">
  <h2>📅 Eventos</h2>
</div>

<div class="modal">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h3 style="margin: 0;">{% if event %}✏️ Editar{% else %} 📅 Novo{% endif %} Evento</h3>
    <button hx-get="/events" hx-target="body" hx-swap="outerHTML"
      style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">
      ✕
    </button>
  </div>

  <form {% if event %}hx-patch{% else %}hx-post{% endif %}="/events{% if event %}/{{ event.id }}{% endif %}"
    hx-target="body" hx-swap="outerHTML" hx-indicator="#loading">
    <label>
      Nome do Evento
      <input type="text" name="name" value="{{ event.name if event else '' }}" required
        placeholder="Digite o nome do evento">
    </label>

    <label>
      Descrição
      <textarea name="description" placeholder="Descreva o evento (opcional)"
        rows="3">{{ event.description if event else '' }}</textarea>
    </label>

    <label style="flex-direction: row; align-items: center; gap: 0.5rem;">
      <input type="checkbox" name="is_recurring" id="is_recurring" onchange="toggleRecurrence(this)" {% if event and
        event.is_recurring %}checked{% endif %}>
      🔄 Este é um evento recorrente
    </label>

    <div id="oneoff" {% if event and event.is_recurring %}style="display:none" {% endif %}>
      <h4 style="color: #27ae60; margin: 1rem 0 0.5rem 0;">📅 Evento Único</h4>
      <label>
        🕐 Data e Hora de Início
        <input type="datetime-local" name="single_start" id="single_start"
          value="{{ event.single_start.strftime('%Y-%m-%dT%H:%M') if event and event.single_start else '' }}" {% if not event or not event.is_recurring %}required{% endif %}
          onchange="validateSingleDates()">
      </label>
      <label>
        🕐 Data e Hora de Fim
        <input type="datetime-local" name="single_end" id="single_end"
          value="{{ event.single_end.strftime('%Y-%m-%dT%H:%M') if event and event.single_end else '' }}" {% if not event or not event.is_recurring %}required{% endif %}
          onchange="validateSingleDates()">
      </label>
    </div>

    <div id="recurrence" {% if event and not event.is_recurring %}style="display:none" {% elif not event
      %}style="display:none" {% endif %}>
      <h4 style="color: #f39c12; margin: 1rem 0 0.5rem 0;">🔄 Evento Recorrente</h4>
      <label>
        📅 Data de Início do Período
        <input type="date" name="recurrence_start_date" id="recurrence_start_date"
          value="{{ event.recurrence_start_date.isoformat() if event and event.recurrence_start_date else '' }}"
          onchange="validateRecurrenceDates()">
      </label>
      <label>
        📅 Data de Fim do Período
        <input type="date" name="recurrence_end_date" id="recurrence_end_date"
          value="{{ event.recurrence_end_date.isoformat() if event and event.recurrence_end_date else '' }}"
          onchange="validateRecurrenceDates()">
      </label>
      <label>
        📆 Dias da Semana
        <input type="text" name="recurrence_rule.weekdays"
          value="{{ event.recurrence_rule.weekdays | join(',') if event and event.recurrence_rule and event.recurrence_rule.get('weekdays') else '' }}"
          placeholder="Ex: 0,1,2,3,4 (Seg-Sex) ou 6 (Dom)">
        <small style="color: #6c757d; font-size: 0.85rem;">
          0=Segunda, 1=Terça, 2=Quarta, 3=Quinta, 4=Sexta, 5=Sábado, 6=Domingo
        </small>
      </label>
      <label>
        🕐 Horários (separados por vírgula)
        <input type="text" name="recurrence_rule.time_windows"
          value="{{ event.recurrence_rule.time_windows | join(',') if event and event.recurrence_rule and event.recurrence_rule.get('time_windows') else '' }}"
          placeholder="Ex: 10:00-12:00,18:00-20:00">
        <small style="color: #6c757d; font-size: 0.85rem;">
          Formato: HH:MM-HH:MM, separados por vírgula
        </small>
      </label>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
      <button type="button" hx-get="/events" hx-swap="innerHTML">
        Cancelar
      </button>
      <button type="submit" id="loading" style="position: relative;">
        <span class="htmx-indicator" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
          ⏳
        </span>
        <span>💾 Salvar Evento</span>
      </button>
    </div>
  </form>
</div>

<script>
  function toggleRecurrence(cb) {
    const recurrence = document.getElementById('recurrence');
    const oneoff = document.getElementById('oneoff');
    const singleInputs = oneoff.querySelectorAll('input[required]');
    const recurrenceInputs = recurrence.querySelectorAll('input');

    if (cb.checked) {
      recurrence.style.display = 'block';
      oneoff.style.display = 'none';
      // Remove required from single event inputs
      singleInputs.forEach(input => input.removeAttribute('required'));
    } else {
      recurrence.style.display = 'none';
      oneoff.style.display = 'block';
      // Add required back to single event inputs
      singleInputs.forEach(input => input.setAttribute('required', ''));
      // Clear recurrence inputs
      recurrenceInputs.forEach(input => input.value = '');
    }
  }

  // Initialize form based on existing event
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    // Use setTimeout to ensure DOM is fully rendered
    setTimeout(() => {
      const isRecurringCheckbox = document.getElementById('is_recurring');
      if (isRecurringCheckbox && isRecurringCheckbox.checked) {
        toggleRecurrence(isRecurringCheckbox);
      }
    }, 10);
  });

  // Also initialize on DOMContentLoaded for direct page loads
  document.addEventListener('DOMContentLoaded', function () {
    const isRecurringCheckbox = document.getElementById('is_recurring');
    if (isRecurringCheckbox && isRecurringCheckbox.checked) {
      console.log("DOMContentLoaded: Initializing recurring event form");
      toggleRecurrence(isRecurringCheckbox);
    }
  });

  function validateSingleDates() {
    const startInput = document.getElementById('single_start');
    const endInput = document.getElementById('single_end');

    if (startInput.value && endInput.value) {
      const startDate = new Date(startInput.value);
      const endDate = new Date(endInput.value);

      if (endDate <= startDate) {
        endInput.setCustomValidity('A data de fim deve ser posterior à data de início');
        endInput.style.borderColor = '#dc3545';
      } else {
        endInput.setCustomValidity('');
        endInput.style.borderColor = '';
      }
    }
  }

  function validateRecurrenceDates() {
    const startInput = document.getElementById('recurrence_start_date');
    const endInput = document.getElementById('recurrence_end_date');

    if (startInput.value && endInput.value) {
      const startDate = new Date(startInput.value);
      const endDate = new Date(endInput.value);

      if (endDate <= startDate) {
        endInput.setCustomValidity('A data de fim deve ser posterior à data de início');
        endInput.style.borderColor = '#dc3545';
      } else {
        endInput.setCustomValidity('');
        endInput.style.borderColor = '';
      }
    }
  }


  // Auto-close modal on successful submission
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    const modal = document.getElementById('modal');
    if (modal) {
      document.getElementById('modal').innerHTML = '';
    }
  });
</script>

{% endblock %}